trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  # -------- PROJEKTI --------
  BACKEND_DIR: "."
  FRONTEND_DIR: "ui-react"
  ARTIFACT_BACKEND: "backend-jar"
  ARTIFACT_FRONTEND: "frontend-dist"

  # -------- AZURE ----------
  # Emri i Service Connection për DEPLOY (ky përdoret nga job-et e deploy-it)
  AZURE_SERVICE_CONN: "rg-igw-demo"
  # Emri i Service Connection ADMIN (duhet Owner/Contributor për të dhënë rolet)
  AZURE_ADMIN_CONN: "rg-igw-demo"  
  AZ_SUBSCRIPTION_ID: "df7afb34-aea5-4f80-a3a6-01fdfb865312"
  AZ_RESOURCE_GROUP: "rg-igw-demo"
  WEBAPP_NAME: "igw-backend-app"
  STORAGE_NAME: "stigmfrontendisme01"

# =========================================================
# 1) STAGE: GRANT RBAC (one-time / idempotent)
# =========================================================
stages:
- stage: GrantRBAC
  displayName: "Grant RBAC to pipeline Service Connection (one-time/idempotent)"
  jobs:
  - job: IdentifyPipelineSP
    displayName: "Identify pipeline Service Principal (appId, objectId)"
    steps:
      - task: AzureCLI@2
        name: identify   # EMËR I STEP-it (përdoret për outputs)
        displayName: "Discover APPID/OBJECTID of $(AZURE_SERVICE_CONN)"
        inputs:
          azureSubscription: '$(AZURE_SERVICE_CONN)'
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            set -euo pipefail
            echo "== Using deployment Service Connection: $(AZURE_SERVICE_CONN)"
            az account set --subscription "$(AZ_SUBSCRIPTION_ID)"

            SUB=$(az account show --query id -o tsv)
            APPID=$(az account show --query user.name -o tsv)   # appId i SC së deploy-it
            if [ -z "$APPID" ]; then
              echo "Nuk u gjet appId nga az account show (user.name)."
              exit 1
            fi
            SP_OBJID=$(az ad sp show --id "$APPID" --query id -o tsv || true)
            SCOPE=$(az storage account show -g '$(AZ_RESOURCE_GROUP)' -n '$(STORAGE_NAME)' --query id -o tsv)

            echo "Subscription: $SUB"
            echo "APPID (SC deploy): $APPID"
            echo "OBJECTID (SC deploy): $SP_OBJID"
            echo "Scope: $SCOPE"

            # Outputs për job-in pasues
            echo "##vso[task.setvariable variable=APPID;isOutput=true]$APPID"
            echo "##vso[task.setvariable variable=SCOPE;isOutput=true]$SCOPE"

  - job: GrantRole
    displayName: "Grant 'Storage Blob Data Contributor' to that SP"
    dependsOn: IdentifyPipelineSP
    steps:
      - task: AzureCLI@2
        displayName: "Assign RBAC on Storage (idempotent)"
        inputs:
          azureSubscription: '$(AZURE_ADMIN_CONN)'
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            set -euo pipefail
            APPID="$(dependencies.IdentifyPipelineSP.outputs['identify.APPID'])"
            SCOPE="$(dependencies.IdentifyPipelineSP.outputs['identify.SCOPE'])"
            if [ -z "$APPID" ] || [ -z "$SCOPE" ]; then
              echo "APPID/SCOPE bosh. Kontrollo job-in IdentifyPipelineSP."
              exit 1
            fi

            echo "Admin SC: $(AZURE_ADMIN_CONN) po jep rol për APPID=$APPID në SCOPE=$SCOPE"
            SP_OBJID=$(az ad sp show --id "$APPID" --query id -o tsv)
            # Idempotent: nëse ekziston, mos e prish pipeline-in
            az role assignment create \
              --assignee-object-id "$SP_OBJID" \
              --assignee-principal-type ServicePrincipal \
              --role "Storage Blob Data Contributor" \
              --scope "$SCOPE" || true

            echo "RBAC granted (ose ekzistonte). Fjet 30s për propagim…"
            sleep 30

# =========================================================
# 2) STAGE: BUILD
# =========================================================
- stage: Build
  displayName: "Build backend & frontend"
  dependsOn: GrantRBAC
  jobs:
  - job: backend
    displayName: Build backend
    steps:
      - checkout: self

      - task: Maven@4
        inputs:
          mavenPomFile: '$(BACKEND_DIR)/pom.xml'
          goals: 'package'
          options: '-DskipTests -ntp'
          jdkVersionOption: '1.21'
          jdkArchitectureOption: 'x64'
          publishJUnitResults: false

      - bash: |
          set -euo pipefail
          mkdir -p "$(Build.ArtifactStagingDirectory)/backend"
          JAR=$(ls $(BACKEND_DIR)/target/*SNAPSHOT.jar 2>/dev/null || true)
          if [ -z "$JAR" ]; then
            JAR=$(ls $(BACKEND_DIR)/target/*.jar | head -n1)
          fi
          echo "Using JAR: $JAR"
          cp "$JAR" "$(Build.ArtifactStagingDirectory)/backend/app.jar"
        displayName: "Prepare app.jar"

      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: "$(Build.ArtifactStagingDirectory)/backend"
          includeRootFolder: false
          archiveType: zip
          archiveFile: "$(Build.ArtifactStagingDirectory)/app.zip"

      - publish: "$(Build.ArtifactStagingDirectory)/app.zip"
        artifact: $(ARTIFACT_BACKEND)

  - job: frontend
    displayName: Build frontend
    steps:
      - checkout: self

      - task: NodeTool@0
        inputs:
          versionSpec: '20.x'

      - task: Cache@2
        inputs:
          key: 'npm | $(Agent.OS) | $(FRONTEND_DIR)/package-lock.json'
          restoreKeys: |
            npm | $(Agent.OS)
          path: '$(FRONTEND_DIR)/node_modules'

      - bash: |
          set -euo pipefail
          cd "$(FRONTEND_DIR)"
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          npm run build
        displayName: "npm install && build"

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(FRONTEND_DIR)/dist'
          ArtifactName: '$(ARTIFACT_FRONTEND)'
          publishLocation: 'Container'

# =========================================================
# 3) STAGE: DEPLOY
# =========================================================
- stage: Deploy
  displayName: Deploy to Azure
  dependsOn: Build
  jobs:
  - deployment: deploy_backend
    displayName: Deploy backend
    environment: 'prod'
    strategy:
      runOnce:
        deploy:
          steps:
            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'current'
                artifactName: '$(ARTIFACT_BACKEND)'
                targetPath: '$(Pipeline.Workspace)/backend'

            - task: AzureCLI@2
              displayName: "Configure Web App"
              inputs:
                azureSubscription: '$(AZURE_SERVICE_CONN)'
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  set -euo pipefail
                  az account set --subscription "$(AZ_SUBSCRIPTION_ID)"
                  az webapp config appsettings set \
                    -g '$(AZ_RESOURCE_GROUP)' -n '$(WEBAPP_NAME)' \
                    --settings WEBSITE_RUN_FROM_PACKAGE=1 >/dev/null
                  # Nëse WebApp është Linux dhe s'ke vendosur stack-un Java 21, çkomento:
                  # az webapp config set -g '$(AZ_RESOURCE_GROUP)' -n '$(WEBAPP_NAME)' --linux-fx-version "JAVA|21-java21"

            - task: AzureWebApp@1
              displayName: "Deploy backend to App Service"
              inputs:
                azureSubscription: '$(AZURE_SERVICE_CONN)'
                appName: '$(WEBAPP_NAME)'
                package: '$(Pipeline.Workspace)/backend/app.zip'

  - deployment: deploy_frontend
    displayName: Deploy frontend (Static Website)
    environment: 'prod'
    strategy:
      runOnce:
        deploy:
          steps:
            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'current'
                artifactName: '$(ARTIFACT_FRONTEND)'
                targetPath: '$(Pipeline.Workspace)/frontend'

            - task: AzureCLI@2
              displayName: "Enable static website & upload"
              inputs:
                azureSubscription: '$(AZURE_SERVICE_CONN)'
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  set -euo pipefail
                  az account set --subscription "$(AZ_SUBSCRIPTION_ID)"

                  # Aktivizo / konfiguro Static Website me AAD
                  az storage blob service-properties update \
                    --account-name '$(STORAGE_NAME)' \
                    --auth-mode login \
                    --static-website \
                    --index-document index.html \
                    --404-document index.html >/dev/null

                  # Upload me overwrite + shmangie cache
                  az storage blob upload-batch \
                    --account-name '$(STORAGE_NAME)' \
                    --auth-mode login \
                    -s '$(Pipeline.Workspace)/frontend' \
                    -d '$web' \
                    --overwrite true \
                    --content-cache-control "no-cache, no-store, must-revalidate" \
                    --only-show-errors

                  ENDPOINT=$(az storage account show -n '$(STORAGE_NAME)' --query "primaryEndpoints.web" -o tsv)
                  echo "Frontend URL => ${ENDPOINT}"
